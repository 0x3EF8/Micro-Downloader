name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: MicroDownloader-Windows.exe
            asset_name: MicroDownloader-Windows.exe
          - os: macos-latest
            artifact_name: MicroDownloader-macOS
            asset_name: MicroDownloader-macOS
          - os: ubuntu-latest
            artifact_name: MicroDownloader-Linux
            asset_name: MicroDownloader-Linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk ffmpeg

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install python-tk ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create assets
        run: |
          python -c "
          import os
          os.makedirs('assets', exist_ok=True)
          os.makedirs('bin', exist_ok=True)
          from PIL import Image
          img = Image.new('RGBA', (64,64), (227,25,55,255))
          img.save('assets/logo.png')
          img.save('assets/logo.ico', format='ICO')
          print('[OK] Assets created')
          "

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader-Windows" --icon assets/logo.ico --add-data "assets;assets" src/main.py

      - name: Build with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader-macOS" --icon assets/logo.ico --add-data "assets:assets" src/main.py

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader-Linux" --add-data "assets:assets" src/main.py

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/MicroDownloader-Windows.exe

      - name: Upload artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/MicroDownloader-macOS.app
          if-no-files-found: ignore

      - name: Upload artifact macOS binary
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-macOS-binary
          path: dist/MicroDownloader-macOS

      - name: Upload artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/MicroDownloader-Linux

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Windows
          if [ -f "artifacts/MicroDownloader-Windows.exe/MicroDownloader-Windows.exe" ]; then
            cp artifacts/MicroDownloader-Windows.exe/MicroDownloader-Windows.exe release/
          fi
          
          # macOS binary
          if [ -f "artifacts/MicroDownloader-macOS-binary/MicroDownloader-macOS" ]; then
            cp artifacts/MicroDownloader-macOS-binary/MicroDownloader-macOS release/
            chmod +x release/MicroDownloader-macOS
          fi
          
          # Linux
          if [ -f "artifacts/MicroDownloader-Linux/MicroDownloader-Linux" ]; then
            cp artifacts/MicroDownloader-Linux/MicroDownloader-Linux release/
            chmod +x release/MicroDownloader-Linux
          fi
          
          ls -la release/

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', steps.get_version.outputs.version) || github.ref_name }}
          name: Micro Downloader v${{ steps.get_version.outputs.version }}
          body: |
            ## Micro Downloader v${{ steps.get_version.outputs.version }}
            
            A lightweight, cross-platform video and audio downloader.
            
            ### Downloads
            
            | Platform | File |
            |----------|------|
            | Windows | `MicroDownloader-Windows.exe` |
            | macOS | `MicroDownloader-macOS` |
            | Linux | `MicroDownloader-Linux` |
            
            ### Installation
            
            **Windows:**
            - Download `MicroDownloader-Windows.exe`
            - Run the executable
            
            **macOS:**
            - Download `MicroDownloader-macOS`
            - Make executable: `chmod +x MicroDownloader-macOS`
            - Run: `./MicroDownloader-macOS`
            - If blocked by Gatekeeper: Right-click > Open
            
            **Linux:**
            - Download `MicroDownloader-Linux`
            - Make executable: `chmod +x MicroDownloader-Linux`
            - Run: `./MicroDownloader-Linux`
            
            ### Requirements
            - FFmpeg (for audio conversion) - bundled or install separately
            
            ### Features
            - Download videos and audio from YouTube and other platforms
            - Multiple format options (MP4, MP3, etc.)
            - Quality selection
            - Progress tracking with marquee title display
            - System tray integration
            - Cross-platform support
          draft: false
          prerelease: false
          files: |
            release/MicroDownloader-Windows.exe
            release/MicroDownloader-macOS
            release/MicroDownloader-Linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
