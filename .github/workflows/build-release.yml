name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.2.0)'
        required: true
        default: '2.2.0'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg for Windows
        run: |
          New-Item -ItemType Directory -Force -Path bin | Out-Null
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp" -Force
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "bin\ffmpeg.exe" -Force
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe" "bin\ffprobe.exe" -Force
          Remove-Item -Recurse -Force "ffmpeg_temp"
          Remove-Item "ffmpeg.zip"
          echo "[OK] FFmpeg downloaded"

      - name: Download Deno for Windows
        run: |
          Invoke-WebRequest -Uri "https://github.com/denoland/deno/releases/latest/download/deno-x86_64-pc-windows-msvc.zip" -OutFile "deno.zip"
          Expand-Archive -Path "deno.zip" -DestinationPath "bin" -Force
          Remove-Item "deno.zip"
          echo "[OK] Deno downloaded"

      - name: Verify assets
        run: |
          if (Test-Path "assets/logo.ico") { echo "[OK] logo.ico found" } else { throw "logo.ico not found" }
          if (Test-Path "assets/logo.png") { echo "[OK] logo.png found" } else { throw "logo.png not found" }

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader" --icon assets/logo.ico --add-data "assets;assets" --add-data "bin;bin" src/main.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Windows
          path: dist/MicroDownloader.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          brew install python-tk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg for macOS
        run: |
          mkdir -p bin
          # Download FFmpeg for macOS (universal binary)
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip" -o ffmpeg.zip
          unzip ffmpeg.zip -d bin/
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffprobe/zip" -o ffprobe.zip
          unzip ffprobe.zip -d bin/
          chmod +x bin/ffmpeg bin/ffprobe
          rm ffmpeg.zip ffprobe.zip
          echo "[OK] FFmpeg downloaded"

      - name: Download Deno for macOS
        run: |
          # Detect architecture
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            curl -L "https://github.com/denoland/deno/releases/latest/download/deno-aarch64-apple-darwin.zip" -o deno.zip
          else
            curl -L "https://github.com/denoland/deno/releases/latest/download/deno-x86_64-apple-darwin.zip" -o deno.zip
          fi
          unzip deno.zip -d bin/
          chmod +x bin/deno
          rm deno.zip
          echo "[OK] Deno downloaded"

      - name: Create macOS icon from PNG
        run: |
          # Create iconset from logo.png
          mkdir -p assets/logo.iconset
          sips -z 16 16 assets/logo.png --out assets/logo.iconset/icon_16x16.png
          sips -z 32 32 assets/logo.png --out assets/logo.iconset/icon_16x16@2x.png
          sips -z 32 32 assets/logo.png --out assets/logo.iconset/icon_32x32.png
          sips -z 64 64 assets/logo.png --out assets/logo.iconset/icon_32x32@2x.png
          sips -z 128 128 assets/logo.png --out assets/logo.iconset/icon_128x128.png
          sips -z 256 256 assets/logo.png --out assets/logo.iconset/icon_128x128@2x.png
          sips -z 256 256 assets/logo.png --out assets/logo.iconset/icon_256x256.png
          sips -z 512 512 assets/logo.png --out assets/logo.iconset/icon_256x256@2x.png
          sips -z 512 512 assets/logo.png --out assets/logo.iconset/icon_512x512.png
          cp assets/logo.png assets/logo.iconset/icon_512x512@2x.png
          iconutil -c icns assets/logo.iconset -o assets/logo.icns
          rm -rf assets/logo.iconset
          echo "[OK] macOS icon created"

      - name: Build .app bundle with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader" --icon assets/logo.icns --add-data "assets:assets" --add-data "bin:bin" --osx-bundle-identifier "com.microdownloader.app" src/main.py

      - name: Create DMG
        run: |
          # Cleanup any existing DMG
          rm -rf dmg_contents MicroDownloader-macOS.dmg || true
          hdiutil detach /Volumes/MicroDownloader 2>/dev/null || true
          
          mkdir -p dmg_contents
          cp -r dist/MicroDownloader.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "MicroDownloader" -srcfolder dmg_contents -ov -format UDZO MicroDownloader-macOS.dmg
          rm -rf dmg_contents
          echo "[OK] DMG created"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-macOS-DMG
          path: MicroDownloader-macOS.dmg

      - name: Zip .app bundle
        run: |
          cd dist
          zip -r ../MicroDownloader-macOS.app.zip MicroDownloader.app
          cd ..

      - name: Upload .app.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-macOS-App
          path: MicroDownloader-macOS.app.zip

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk libfuse2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg for Linux
        run: |
          mkdir -p bin
          wget -q "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" -O ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          cp ffmpeg-*-amd64-static/ffmpeg bin/
          cp ffmpeg-*-amd64-static/ffprobe bin/
          chmod +x bin/ffmpeg bin/ffprobe
          rm -rf ffmpeg-*-amd64-static ffmpeg.tar.xz
          echo "[OK] FFmpeg downloaded"

      - name: Download Deno for Linux
        run: |
          wget -q "https://github.com/denoland/deno/releases/latest/download/deno-x86_64-unknown-linux-gnu.zip" -O deno.zip
          unzip deno.zip -d bin/
          chmod +x bin/deno
          rm deno.zip
          echo "[OK] Deno downloaded"

      - name: Verify assets
        run: |
          test -f assets/logo.png && echo "[OK] logo.png found" || exit 1
          test -f assets/logo.ico && echo "[OK] logo.ico found" || exit 1

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name "MicroDownloader" --add-data "assets:assets" --add-data "bin:bin" src/main.py

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Linux
          path: dist/MicroDownloader

      - name: Create AppImage structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp dist/MicroDownloader AppDir/usr/bin/
          cp assets/logo.png AppDir/usr/share/icons/hicolor/256x256/apps/microdownloader.png
          cp assets/logo.png AppDir/microdownloader.png
          
          cat > AppDir/microdownloader.desktop << 'EOF'
          [Desktop Entry]
          Name=Micro Downloader
          Exec=MicroDownloader
          Icon=microdownloader
          Type=Application
          Categories=Network;
          Comment=A lightweight video and audio downloader
          EOF
          
          cp AppDir/microdownloader.desktop AppDir/usr/share/applications/
          
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/MicroDownloader" "$@"
          EOF
          
          chmod +x AppDir/AppRun
          chmod +x AppDir/usr/bin/MicroDownloader

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir MicroDownloader-Linux.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Linux-AppImage
          path: MicroDownloader-Linux.AppImage

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Windows
          if [ -f "artifacts/MicroDownloader-Windows/MicroDownloader.exe" ]; then
            cp artifacts/MicroDownloader-Windows/MicroDownloader.exe release/MicroDownloader-Windows.exe
          fi
          
          # macOS DMG
          if [ -f "artifacts/MicroDownloader-macOS-DMG/MicroDownloader-macOS.dmg" ]; then
            cp artifacts/MicroDownloader-macOS-DMG/MicroDownloader-macOS.dmg release/
          fi
          
          # macOS App.zip
          if [ -f "artifacts/MicroDownloader-macOS-App/MicroDownloader-macOS.app.zip" ]; then
            cp artifacts/MicroDownloader-macOS-App/MicroDownloader-macOS.app.zip release/
          fi
          
          # Linux binary
          if [ -f "artifacts/MicroDownloader-Linux/MicroDownloader" ]; then
            cp artifacts/MicroDownloader-Linux/MicroDownloader release/MicroDownloader-Linux
            chmod +x release/MicroDownloader-Linux
          fi
          
          # Linux AppImage
          if [ -f "artifacts/MicroDownloader-Linux-AppImage/MicroDownloader-Linux.AppImage" ]; then
            cp artifacts/MicroDownloader-Linux-AppImage/MicroDownloader-Linux.AppImage release/
            chmod +x release/MicroDownloader-Linux.AppImage
          fi
          
          ls -la release/

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', steps.get_version.outputs.version) || github.ref_name }}
          name: Micro Downloader v${{ steps.get_version.outputs.version }}
          body: |
            ## Micro Downloader v${{ steps.get_version.outputs.version }}
            
            A lightweight, cross-platform video and audio downloader.
            
            **FFmpeg & Deno bundled** - No additional installations required!
            
            ### Downloads
            
            | Platform | File | Description |
            |----------|------|-------------|
            | **Windows** | `MicroDownloader-Windows.exe` | Standalone executable (double-click to run) |
            | **macOS** | `MicroDownloader-macOS.dmg` | Disk image (drag to Applications) |
            | **macOS** | `MicroDownloader-macOS.app.zip` | App bundle (unzip and run) |
            | **Linux** | `MicroDownloader-Linux.AppImage` | AppImage (double-click to run) |
            | **Linux** | `MicroDownloader-Linux` | Standalone binary |
            
            ### Installation
            
            **Windows:**
            - Download `MicroDownloader-Windows.exe`
            - Double-click to run (no installation needed)
            
            **macOS (DMG - Recommended):**
            - Download `MicroDownloader-macOS.dmg`
            - Double-click to open
            - Drag `MicroDownloader.app` to Applications folder
            - If blocked by Gatekeeper: Right-click > Open
            
            **macOS (App Bundle):**
            - Download `MicroDownloader-macOS.app.zip`
            - Unzip the file
            - Move `MicroDownloader.app` to Applications
            - Double-click to run
            
            **Linux (AppImage - Recommended):**
            - Download `MicroDownloader-Linux.AppImage`
            - Make executable: `chmod +x MicroDownloader-Linux.AppImage`
            - Double-click or run: `./MicroDownloader-Linux.AppImage`
            
            **Linux (Binary):**
            - Download `MicroDownloader-Linux`
            - Make executable: `chmod +x MicroDownloader-Linux`
            - Run: `./MicroDownloader-Linux`
            
            ### Features
            - Download videos and audio from YouTube and 1000+ sites
            - Multiple format options (MP4, MP3, WEBM, etc.)
            - Quality selection (Best, 1080p, 720p, etc.)
            - Progress tracking with marquee title display
            - System tray integration
            - **FFmpeg bundled** - audio conversion works out of the box
            - **Deno bundled** - improved site compatibility via JS runtime
            - Cross-platform support (Windows, macOS, Linux)
          draft: false
          prerelease: false
          files: |
            release/MicroDownloader-Windows.exe
            release/MicroDownloader-macOS.dmg
            release/MicroDownloader-macOS.app.zip
            release/MicroDownloader-Linux.AppImage
            release/MicroDownloader-Linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
