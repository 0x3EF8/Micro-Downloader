name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '2.1.0'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create assets
        run: |
          python -c "
          import os
          os.makedirs('assets', exist_ok=True)
          os.makedirs('bin', exist_ok=True)
          from PIL import Image
          img = Image.new('RGBA', (64,64), (227,25,55,255))
          img.save('assets/logo.png')
          img.save('assets/logo.ico', format='ICO')
          print('[OK] Assets created')
          "

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader" --icon assets/logo.ico --add-data "assets;assets" src/main.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Windows
          path: dist/MicroDownloader.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          brew install python-tk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create assets
        run: |
          python -c "
          import os
          os.makedirs('assets', exist_ok=True)
          os.makedirs('bin', exist_ok=True)
          from PIL import Image
          img = Image.new('RGBA', (64,64), (227,25,55,255))
          img.save('assets/logo.png')
          img.save('assets/logo.ico', format='ICO')
          
          # Create ICNS for macOS
          icon_sizes = [16, 32, 64, 128, 256, 512]
          img_large = Image.new('RGBA', (512,512), (227,25,55,255))
          img_large.save('assets/logo.icns', format='ICNS')
          print('[OK] Assets created')
          "

      - name: Build .app bundle with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader" --icon assets/logo.icns --add-data "assets:assets" --osx-bundle-identifier "com.microdownloader.app" src/main.py

      - name: Create DMG
        run: |
          # Create a folder for DMG contents
          mkdir -p dmg_contents
          cp -r dist/MicroDownloader.app dmg_contents/
          
          # Create symbolic link to Applications folder
          ln -s /Applications dmg_contents/Applications
          
          # Create DMG
          hdiutil create -volname "MicroDownloader" -srcfolder dmg_contents -ov -format UDZO MicroDownloader-macOS.dmg
          
          echo "[OK] DMG created"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-macOS-DMG
          path: MicroDownloader-macOS.dmg

      - name: Zip .app bundle
        run: |
          cd dist
          zip -r ../MicroDownloader-macOS.app.zip MicroDownloader.app
          cd ..

      - name: Upload .app.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-macOS-App
          path: MicroDownloader-macOS.app.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create assets
        run: |
          python -c "
          import os
          os.makedirs('assets', exist_ok=True)
          os.makedirs('bin', exist_ok=True)
          from PIL import Image
          img = Image.new('RGBA', (64,64), (227,25,55,255))
          img.save('assets/logo.png')
          img.save('assets/logo.ico', format='ICO')
          print('[OK] Assets created')
          "

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "MicroDownloader" --add-data "assets:assets" src/main.py

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Linux
          path: dist/MicroDownloader

      - name: Create AppImage structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp dist/MicroDownloader AppDir/usr/bin/
          cp assets/logo.png AppDir/usr/share/icons/hicolor/256x256/apps/microdownloader.png
          cp assets/logo.png AppDir/microdownloader.png
          
          cat > AppDir/usr/share/applications/microdownloader.desktop << EOF
          [Desktop Entry]
          Name=Micro Downloader
          Exec=MicroDownloader
          Icon=microdownloader
          Type=Application
          Categories=Utility;Network;
          Comment=A lightweight video and audio downloader
          EOF
          
          cp AppDir/usr/share/applications/microdownloader.desktop AppDir/microdownloader.desktop
          
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/MicroDownloader" "$@"
          EOF
          
          chmod +x AppDir/AppRun
          chmod +x AppDir/usr/bin/MicroDownloader

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir MicroDownloader-Linux.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicroDownloader-Linux-AppImage
          path: MicroDownloader-Linux.AppImage

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Windows
          if [ -f "artifacts/MicroDownloader-Windows/MicroDownloader.exe" ]; then
            cp artifacts/MicroDownloader-Windows/MicroDownloader.exe release/MicroDownloader-Windows.exe
          fi
          
          # macOS DMG
          if [ -f "artifacts/MicroDownloader-macOS-DMG/MicroDownloader-macOS.dmg" ]; then
            cp artifacts/MicroDownloader-macOS-DMG/MicroDownloader-macOS.dmg release/
          fi
          
          # macOS App.zip
          if [ -f "artifacts/MicroDownloader-macOS-App/MicroDownloader-macOS.app.zip" ]; then
            cp artifacts/MicroDownloader-macOS-App/MicroDownloader-macOS.app.zip release/
          fi
          
          # Linux binary
          if [ -f "artifacts/MicroDownloader-Linux/MicroDownloader" ]; then
            cp artifacts/MicroDownloader-Linux/MicroDownloader release/MicroDownloader-Linux
            chmod +x release/MicroDownloader-Linux
          fi
          
          # Linux AppImage
          if [ -f "artifacts/MicroDownloader-Linux-AppImage/MicroDownloader-Linux.AppImage" ]; then
            cp artifacts/MicroDownloader-Linux-AppImage/MicroDownloader-Linux.AppImage release/
            chmod +x release/MicroDownloader-Linux.AppImage
          fi
          
          ls -la release/

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', steps.get_version.outputs.version) || github.ref_name }}
          name: Micro Downloader v${{ steps.get_version.outputs.version }}
          body: |
            ## Micro Downloader v${{ steps.get_version.outputs.version }}
            
            A lightweight, cross-platform video and audio downloader.
            
            ### Downloads
            
            | Platform | File | Description |
            |----------|------|-------------|
            | **Windows** | `MicroDownloader-Windows.exe` | Standalone executable |
            | **macOS** | `MicroDownloader-macOS.dmg` | Disk image (drag to Applications) |
            | **macOS** | `MicroDownloader-macOS.app.zip` | App bundle (unzip and run) |
            | **Linux** | `MicroDownloader-Linux.AppImage` | AppImage (double-click to run) |
            | **Linux** | `MicroDownloader-Linux` | Standalone binary |
            
            ### Installation
            
            **Windows:**
            - Download `MicroDownloader-Windows.exe`
            - Double-click to run
            
            **macOS (DMG - Recommended):**
            - Download `MicroDownloader-macOS.dmg`
            - Double-click to open
            - Drag `MicroDownloader.app` to Applications folder
            - If blocked by Gatekeeper: Right-click > Open
            
            **macOS (App Bundle):**
            - Download `MicroDownloader-macOS.app.zip`
            - Unzip the file
            - Move `MicroDownloader.app` to Applications
            - Double-click to run
            
            **Linux (AppImage - Recommended):**
            - Download `MicroDownloader-Linux.AppImage`
            - Make executable: `chmod +x MicroDownloader-Linux.AppImage`
            - Double-click or run: `./MicroDownloader-Linux.AppImage`
            
            **Linux (Binary):**
            - Download `MicroDownloader-Linux`
            - Make executable: `chmod +x MicroDownloader-Linux`
            - Run: `./MicroDownloader-Linux`
            
            ### Requirements
            - FFmpeg (for audio conversion) - install separately if not bundled
            
            ### Features
            - Download videos and audio from YouTube and 1000+ sites
            - Multiple format options (MP4, MP3, WEBM, etc.)
            - Quality selection (Best, 1080p, 720p, etc.)
            - Progress tracking with marquee title display
            - System tray integration
            - Cross-platform support (Windows, macOS, Linux)
          draft: false
          prerelease: false
          files: |
            release/MicroDownloader-Windows.exe
            release/MicroDownloader-macOS.dmg
            release/MicroDownloader-macOS.app.zip
            release/MicroDownloader-Linux.AppImage
            release/MicroDownloader-Linux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
