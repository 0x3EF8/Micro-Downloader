name: Cross-Platform Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk ffmpeg xvfb

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install python-tk ffmpeg

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ffmpeg -y

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Create test assets
        run: |
          mkdir -p assets bin
          # Create a placeholder icon for testing
          python -c "from PIL import Image; img = Image.new('RGBA', (64,64), (227,25,55,255)); img.save('assets/logo.png')"

      - name: Syntax and Import Test
        run: |
          python -c "import ast; ast.parse(open('src/main.py').read()); print('✓ Syntax OK')"
          python -c "
          import sys
          sys.path.insert(0, 'src')
          # Test imports work
          import platform
          print(f'Platform: {platform.system()}')
          
          # Test platform detection
          exec(open('src/main.py').read().split('class ToolTip')[0])
          print(f'IS_WINDOWS: {IS_WINDOWS}')
          print(f'IS_MACOS: {IS_MACOS}')
          print(f'IS_LINUX: {IS_LINUX}')
          print(f'SYSTEM_FONT: {SYSTEM_FONT}')
          print('✓ All imports and platform detection OK')
          "

      - name: GUI Import Test (Linux with Xvfb)
        if: runner.os == 'Linux'
        run: |
          xvfb-run -a python -c "
          import tkinter as tk
          root = tk.Tk()
          root.withdraw()
          print('✓ Tkinter works on Linux')
          root.destroy()
          "

      - name: GUI Import Test (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          python -c "
          import tkinter as tk
          root = tk.Tk()
          root.withdraw()
          print('✓ Tkinter works')
          root.destroy()
          "

      - name: Full Module Test
        run: |
          python -c "
          import sys
          import os
          sys.path.insert(0, 'src')
          os.chdir('.')
          
          # Create minimal test environment
          os.makedirs('assets', exist_ok=True)
          os.makedirs('bin', exist_ok=True)
          
          from PIL import Image
          img = Image.new('RGBA', (64,64), (227,25,55,255))
          img.save('assets/logo.png')
          img.save('assets/logo.ico', format='ICO')
          
          print('✓ Test assets created')
          print('✓ All tests passed!')
          "
